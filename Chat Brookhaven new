-- [ مدعوم من جميع الـ Executors | شغال على الجوال والكمبيوتر ]
-- يعمل على: Synapse, Krnl, Fluxus, Delta, Comet, Script-Ware, etc.

if not game:IsLoaded() then game.Loaded:Wait() end

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- استخدام PlayerGui بدل CoreGui للتوافق الأعلى
local gui = Instance.new("ScreenGui")
gui.Name = "RPChatGui"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.DisplayOrder = 999
gui.Parent = playerGui  -- أكثر أمانًا من CoreGui

-- البحث عن الـ Remote
local remote
pcall(function()
	remote = ReplicatedStorage:WaitForChild("RE", 10):WaitForChild("1RPNam1eTex1t", 10)
end)
if not remote then
	warn("لم يتم العثور على الـ Remote! تأكد من الاسم.")
	return
end

-- دالة سحب متوافقة مع الجوال والكمبيوتر
local function makeDraggable(obj)
	if not obj then return end
	obj.Active = true

	local dragging = false
	local dragInput, dragStart, startPos

	local function update(input)
		if not obj or not obj.Parent then return end
		local delta = input.Position - dragStart
		obj.Position = UDim2.new(
			startPos.X.Scale,
			startPos.X.Offset + delta.X,
			startPos.Y.Scale,
			startPos.Y.Offset + delta.Y
		)
	end

	obj.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			startPos = obj.Position

			local conn
			conn = input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
					if conn.Connected then conn:Disconnect() end
				end
			end)
		end
	end)

	obj.InputChanged:Connect(function(input)
		if (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) and dragging then
			dragInput = input
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if input == dragInput and dragging and obj and obj.Parent then
			update(input)
		end
	end)
end

-- نص الترحيب (يختفي بعد 3 ثواني)
local welcomeLabel = Instance.new("TextLabel")
welcomeLabel.Size = UDim2.fromOffset(400, 80)
welcomeLabel.Position = UDim2.fromScale(0.5, 0.5)
welcomeLabel.AnchorPoint = Vector2.new(0.5, 0.5)
welcomeLabel.BackgroundTransparency = 1
welcomeLabel.Text = "تم تفعيل شات الـ RP"
welcomeLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
welcomeLabel.FontFace = Font.fromEnum(Enum.Font.GothamBold)
welcomeLabel.TextSize = 36
welcomeLabel.ZIndex = 10
welcomeLabel.Parent = gui

task.delay(3, function()
	if welcomeLabel and welcomeLabel.Parent then
		welcomeLabel:Destroy()
	end
end)

-- الإطار الرئيسي
local frame = Instance.new("Frame")
frame.Size = UDim2.fromOffset(300, 100)
frame.Position = UDim2.fromScale(0.5, 0.5)
frame.AnchorPoint = Vector2.new(0.5, 0.5)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
frame.BackgroundTransparency = 0.1
frame.BorderSizePixel = 0
frame.ClipsDescendants = true
frame.Visible = false
frame.Parent = gui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 16)
corner.Parent = frame

-- ظل
local shadow = Instance.new("ImageLabel")
shadow.Size = UDim2.fromOffset(330, 130)
shadow.Position = UDim2.fromOffset(-15, 10)
shadow.BackgroundTransparency = 1
shadow.Image = "rbxassetid://6014261993"
shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
shadow.ImageTransparency = 0.7
shadow.ScaleType = Enum.ScaleType.Slice
shadow.SliceCenter = Rect.new(49, 49, 450, 450)
shadow.ZIndex = 0
shadow.Parent = frame

-- عنوان
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -50, 0, 40)
title.BackgroundTransparency = 1
title.Text = "دردشة الـ RP"
title.TextColor3 = Color3.fromRGB(150, 220, 255)
title.FontFace = Font.fromEnum(Enum.Font.GothamBold)
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left
title.ZIndex = 6
title.Parent = frame

-- زر الإغلاق
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.fromOffset(32, 32)
closeButton.Position = UDim2.new(1, -40, 0, 4)
closeButton.BackgroundTransparency = 1
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 100, 100)
closeButton.FontFace = Font.fromEnum(Enum.Font.GothamBold)
closeButton.TextSize = 20
closeButton.ZIndex = 6
closeButton.Parent = frame

-- مربع الكتابة
local textBox = Instance.new("TextBox")
textBox.Size = UDim2.new(1, -20, 0, 38)
textBox.Position = UDim2.fromOffset(10, 45)
textBox.BackgroundColor3 = Color3.fromRGB(40, 40, 55)
textBox.BackgroundTransparency = 0.2
textBox.BorderSizePixel = 0
textBox.Text = ""
textBox.PlaceholderText = "اكتب..."
textBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 170)
textBox.TextColor3 = Color3.fromRGB(220, 220, 255)
textBox.FontFace = Font.fromEnum(Enum.Font.GothamBold)
textBox.TextSize = 18
textBox.ZIndex = 2
textBox.Parent = frame

local textBoxCorner = Instance.new("UICorner")
textBoxCorner.CornerRadius = UDim.new(0, 10)
textBoxCorner.Parent = textBox

-- أيقونة الإرسال
local sendIcon = Instance.new("ImageLabel")
sendIcon.Size = UDim2.fromOffset(28, 28)
sendIcon.Position = UDim2.new(1, -38, 0, 5)
sendIcon.BackgroundTransparency = 1
sendIcon.Image = "rbxassetid://7072706793"
sendIcon.ImageColor3 = Color3.fromRGB(100, 180, 255)
sendIcon.ZIndex = 3
sendIcon.Parent = textBox

-- صوت الإرسال
local bubbleSound = Instance.new("Sound")
bubbleSound.SoundId = "rbxassetid://138104622"
bubbleSound.Volume = 0.6
bubbleSound.Parent = frame

-- زر فتح الشات
local openButton = Instance.new("TextButton")
openButton.Size = UDim2.fromOffset(160, 45)
openButton.Position = UDim2.fromScale(0.5, 0.9)
openButton.AnchorPoint = Vector2.new(0.5, 0.5)
openButton.BackgroundColor3 = Color3.fromRGB(30, 140, 255)
openButton.BackgroundTransparency = 0.2
openButton.Text = "افتح الشات (T)"
openButton.TextColor3 = Color3.fromRGB(255, 255, 255)
openButton.FontFace = Font.fromEnum(Enum.Font.GothamBold)
openButton.TextSize = 17
openButton.ZIndex = 10
openButton.Parent = gui

local openCorner = Instance.new("UICorner")
openCorner.CornerRadius = UDim.new(0, 12)
openCorner.Parent = openButton

-- تفعيل السحب
makeDraggable(frame)
makeDraggable(openButton)

-- فتح وإغلاق الشات
local isOpen = false

local function openChat()
	if isOpen then return end
	isOpen = true
	frame.Visible = true
	openButton.Visible = false
	task.delay(0.1, function()
		if textBox and textBox.Parent then
			textBox:CaptureFocus()
		end
	end)
end

local function closeChat()
	if not isOpen then return end
	isOpen = false
	frame.Visible = false
	openButton.Visible = true
	if textBox then
		textBox:ReleaseFocus()
	end
end

openButton.MouseButton1Click:Connect(openChat)
closeButton.MouseButton1Click:Connect(closeChat)

UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.KeyCode == Enum.KeyCode.T then
		if isOpen then closeChat() else openChat() end
	end
end)

-- دالة الإرسال (محمية)
local sending = false
local function sendText()
	if sending or not isOpen then return end
	sending = true

	local txt = textBox.Text:gsub("^%s*(.-)%s*$", "%1") -- trim
	if txt == "" then txt = " " end
	if #txt > 150 then txt = txt:sub(1, 150) end

	-- إرسال آمن
	pcall(function()
		remote:FireServer("RolePlayName", txt)
	end)

	-- تأثيرات
	if bubbleSound then bubbleSound:Play() end
	if sendIcon then
		sendIcon.ImageColor3 = Color3.fromRGB(80, 220, 120)
		task.delay(0.2, function()
			if sendIcon and sendIcon.Parent then
				sendIcon.ImageColor3 = Color3.fromRGB(100, 180, 255)
			end
		end)
	end

	textBox.Text = ""
	task.delay(0.3, function() sending = false end)
end

textBox.FocusLost:Connect(function(enterPressed)
	if enterPressed then sendText() end
end)

sendIcon.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		sendText()
	end
end)

-- حماية من الـ Respawn
player.CharacterAdded:Connect(function()
	task.delay(1, function()
		if not isOpen and openButton and openButton.Parent then
			openButton.Visible = true
		end
	end)
end)

-- منع التكرار (إذا تم حقنه أكثر من مرة)
if getgenv and getgenv().RPChatLoaded then
	warn("الشات مفعل مسبقًا!")
	return
else
	if getgenv then getgenv().RPChatLoaded = true end
end

-- خدمات
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local StarterGui = game:GetService("StarterGui")

-- متغيرات
local targetPrefix = ""
local bangingBack = false
local bangingFront = false
local followConnBack = nil
local followConnFront = nil
local animTrackBack = nil
local animTrackFront = nil
local syncTrack = nil
local BANG_SPEED = 30
local BASE_DISTANCE = 1.2
local OSCILLATION_RANGE = 0.3
local OSCILLATION_SPEED = 4
local timeElapsedBack = 0
local timeElapsedFront = 0
local lockedFace = nil
local selectedEmoteKey = nil
local targetPlayer = nil
local targetAnimId = "غير متاح"
local syncEnabled = false
local syncConn = nil

-- حفظ الحركات
local CustomEmotes = {}
local SETTINGS_KEY = "BangProSync_2025"

local function saveEmotes()
    local data = {}
    for name, emote in pairs(CustomEmotes) do
        table.insert(data, {name = name, id = emote.id})
    end
    pcall(function() writefile(SETTINGS_KEY, HttpService:JSONEncode(data)) end)
end

local function loadEmotes()
    local success, data = pcall(function() return HttpService:JSONDecode(readfile(SETTINGS_KEY)) end)
    if success and type(data) == "table" then
        for _, item in ipairs(data) do
            CustomEmotes[item.name] = {id = item.id}
        end
    end
end

pcall(loadEmotes)

if next(CustomEmotes) == nil then
    CustomEmotes["Flirty Backshot"] = {id = "18457434022"}
    CustomEmotes["Hype Thrust"] = {id = "18394713579"}
    saveEmotes()
end

local currentEmoteKey = next(CustomEmotes)
selectedEmoteKey = currentEmoteKey
local ANIM_ID = "rbxassetid://" .. CustomEmotes[currentEmoteKey].id

-- وظائف
local function getGuiParent()
    if gethui then local ok, ui = pcall(gethui); if ok and ui then return ui end end
    return game:GetService("CoreGui")
end

local function findTargetByPrefix(prefix)
    prefix = (prefix or ""):lower()
    if prefix == "" then return nil end
    for _, p in Players:GetPlayers() do
        if p ~= LocalPlayer and p.Name:lower():sub(1, #prefix) == prefix then return p end
    end
    return nil
end

local function playAnim(id)
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("Humanoid") then return nil end
    local hum = char:FindFirstChildOfClass("Humanoid")
    local animator = hum:FindFirstChildOfClass("Animator") or Instance.new("Animator", hum)
    local anim = Instance.new("Animation")
    anim.AnimationId = "rbxassetid://" .. id
    local track = animator:LoadAnimation(anim)
    track.Looped = true
    track:Play()
    return track
end

local function stopAnim(track)
    if track and track.IsPlaying then pcall(function() track:Stop() end) end
end

-- تتبع أنيميشن اللاعب
local function getPlayerAnimationId(player)
    if not player or not player.Character then return nil end
    local hum = player.Character:FindFirstChildOfClass("Humanoid")
    if not hum then return nil end
    for _, track in pairs(hum:GetPlayingAnimationTracks()) do
        if track.Animation and track.Animation.AnimationId then
            local id = track.Animation.AnimationId:match("%d+")
            if id and id ~= "0" then
                return id
            end
        end
    end
    return nil
end

-- مزامنة الرقصة
local function startSync()
    if syncEnabled then return end
    local target = findTargetByPrefix(targetPrefix)
    if not target or not target.Character then warn("لا يوجد لاعب."); return end
    targetPlayer = target
    syncEnabled = true
    if syncConn then syncConn:Disconnect() end

    syncConn = RunService.Heartbeat:Connect(function()
        if not syncEnabled or not targetPlayer or not targetPlayer.Character then return end
        local newId = getPlayerAnimationId(targetPlayer)
        if newId and newId ~= targetAnimId then
            targetAnimId = newId
            if PlayerIdLabel then
                PlayerIdLabel.Text = "ID اللاعب: " .. targetAnimId
            end
            if syncTrack then stopAnim(syncTrack) end
            syncTrack = playAnim(newId)
        end
    end)
end

local function stopSync()
    syncEnabled = false
    if syncConn then syncConn:Disconnect(); syncConn = nil end
    stopAnim(syncTrack); syncTrack = nil
end

-- Bang خلفي
local function startBangBack()
    if bangingBack then return end
    local target = findTargetByPrefix(targetPrefix)
    if not target or not target.Character then warn("لا يوجد لاعب."); return end
    targetPlayer = target
    animTrackBack = playAnim(CustomEmotes[currentEmoteKey].id)
    bangingBack = true
    timeElapsedBack = 0
    if followConnBack then followConnBack:Disconnect() end

    local lastTargetPos = target.Character.HumanoidRootPart.Position
    local velocity = Vector3.new()
    local alpha = 0.2

    followConnBack = RunService.Heartbeat:Connect(function(dt)
        if not bangingBack then return end
        local myChar = LocalPlayer.Character
        local tChar = target.Character
        if not (myChar and tChar) then return end
        local myRoot = myChar:FindFirstChild("HumanoidRootPart")
        local tRoot = tChar:FindFirstChild("HumanoidRootPart")
        if not (myRoot and tRoot) then return end

        local pos = tRoot.Position
        velocity = velocity:Lerp(pos - lastTargetPos, alpha)
        lastTargetPos = pos
        timeElapsedBack += dt

        local osc = math.sin(timeElapsedBack * OSCILLATION_SPEED) * OSCILLATION_RANGE
        local pred = pos + velocity * 0.12
        local dir = -tRoot.CFrame.LookVector
        local desired = pred + dir * (BASE_DISTANCE + osc)

        local facePos = pred
        if lockedFace == "front" then facePos = pred
        elseif lockedFace == "back" then facePos = pred + dir * BASE_DISTANCE * 2 end

        local targetCF = CFrame.new(desired, facePos)
        local lerp = math.clamp(BANG_SPEED * dt * 12, 0, 1)
        myRoot.CFrame = myRoot.CFrame:Lerp(targetCF, lerp)
    end)
end

local function stopBangBack()
    bangingBack = false
    if followConnBack then followConnBack:Disconnect(); followConnBack = nil end
    stopAnim(animTrackBack); animTrackBack = nil
end

-- Bang أمامي
local function startBangFront()
    if bangingFront then return end
    local target = findTargetByPrefix(targetPrefix)
    if not target or not target.Character then warn("لا يوجد لاعب."); return end
    targetPlayer = target
    animTrackFront = playAnim(CustomEmotes[currentEmoteKey].id)
    bangingFront = true
    timeElapsedFront = 0
    if followConnFront then followConnFront:Disconnect() end

    local lastTargetPos = target.Character.HumanoidRootPart.Position
    local velocity = Vector3.new()
    local alpha = 0.2

    followConnFront = RunService.Heartbeat:Connect(function(dt)
        if not bangingFront then return end
        local myChar = LocalPlayer.Character
        local tChar = target.Character
        if not (myChar and tChar) then return end
        local myRoot = myChar:FindFirstChild("HumanoidRootPart")
        local tRoot = tChar:FindFirstChild("HumanoidRootPart")
        if not (myRoot and tRoot) then return end

        local pos = tRoot.Position
        velocity = velocity:Lerp(pos - lastTargetPos, alpha)
        lastTargetPos = pos
        timeElapsedFront += dt

        local osc = math.sin(timeElapsedFront * OSCILLATION_SPEED) * OSCILLATION_RANGE
        local pred = pos + velocity * 0.12
        local dir = tRoot.CFrame.LookVector
        local desired = pred + dir * (BASE_DISTANCE + osc)

        local facePos = pred
        if lockedFace == "back" then facePos = pred + dir * BASE_DISTANCE * 2
        elseif lockedFace == "front" then facePos = pred end

        local targetCF = CFrame.new(desired, facePos)
        local lerp = math.clamp(BANG_SPEED * dt * 12, 0, 1)
        myRoot.CFrame = myRoot.CFrame:Lerp(targetCF, lerp)
    end)
end

local function stopBangFront()
    bangingFront = false
    if followConnFront then followConnFront:Disconnect(); followConnFront = nil end
    stopAnim(animTrackFront); animTrackFront = nil
end

=== نهاية الجزء الأول ===
-- UI
local parent = getGuiParent()
local old = parent:FindFirstChild("BangSyncFull")
if old then old:Destroy() end

local ScreenGui = Instance.new("ScreenGui", parent)
ScreenGui.Name = "BangSyncFull"
ScreenGui.ResetOnSpawn = false

local OpenBtn = Instance.new("TextButton", ScreenGui)
OpenBtn.Size = UDim2.new(0, 60, 0, 60)
OpenBtn.Position = UDim2.new(0, 20, 0, 200)
OpenBtn.BackgroundColor3 = Color3.fromRGB(255, 20, 147)
OpenBtn.Text = "Bang"
OpenBtn.TextScaled = true
OpenBtn.TextColor3 = Color3.new(1,1,1)
OpenBtn.Active = true
OpenBtn.Draggable = true
Instance.new("UICorner", OpenBtn).CornerRadius = UDim.new(1, 0)

local Panel = Instance.new("Frame", ScreenGui)
Panel.Size = UDim2.new(0, 380, 0, 700)
Panel.Position = UDim2.new(0, 100, 0, 100)
Panel.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
Panel.Visible = false
Panel.Active = true
Panel.Draggable = true
Instance.new("UICorner", Panel).CornerRadius = UDim.new(0, 14)

-- Logs خارج القائمة
local LogsFrame = Instance.new("Frame", Panel)
LogsFrame.Size = UDim2.new(1, -20, 0, 40)
LogsFrame.Position = UDim2.new(0, 10, 0, 10)
LogsFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
Instance.new("UICorner", LogsFrame).CornerRadius = UDim.new(0, 10)

local LogsLabel = Instance.new("TextLabel", LogsFrame)
LogsLabel.Size = UDim2.new(1, -80, 1, 0)
LogsLabel.BackgroundTransparency = 1
LogsLabel.Text = "ID الحركة المختارة: " .. (CustomEmotes[selectedEmoteKey].id or "N/A")
LogsLabel.TextColor3 = Color3.fromRGB(200, 200, 255)
LogsLabel.TextScaled = true
LogsLabel.TextXAlignment = Enum.TextXAlignment.Left

local CopySelectedBtn = Instance.new("TextButton", LogsFrame)
CopySelectedBtn.Size = UDim2.new(0, 70, 1, 0)
CopySelectedBtn.Position = UDim2.new(1, -75, 0, 0)
CopySelectedBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 255)
CopySelectedBtn.Text = "نسخ"
CopySelectedBtn.TextScaled = true
CopySelectedBtn.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", CopySelectedBtn).CornerRadius = UDim.new(0, 6)
CopySelectedBtn.MouseButton1Click:Connect(function()
    if selectedEmoteKey and CustomEmotes[selectedEmoteKey] then
        setclipboard(CustomEmotes[selectedEmoteKey].id)
        StarterGui:SetCore("SendNotification", {Title = "تم النسخ!", Text = "ID: " .. CustomEmotes[selectedEmoteKey].id, Duration = 2})
    end
end)

-- ID اللاعب
local PlayerIdFrame = Instance.new("Frame", Panel)
PlayerIdFrame.Size = UDim2.new(1, -20, 0, 40)
PlayerIdFrame.Position = UDim2.new(0, 10, 0, 60)
PlayerIdFrame.BackgroundColor3 = Color3.fromRGB(50, 40, 40)
Instance.new("UICorner", PlayerIdFrame).CornerRadius = UDim.new(0, 10)

local PlayerIdLabel = Instance.new("TextLabel", PlayerIdFrame)
PlayerIdLabel.Size = UDim2.new(1, -80, 1, 0)
PlayerIdLabel.BackgroundTransparency = 1
PlayerIdLabel.Text = "ID اللاعب: غير متاح"
PlayerIdLabel.TextColor3 = Color3.fromRGB(255, 150, 150)
PlayerIdLabel.TextScaled = true
PlayerIdLabel.TextXAlignment = Enum.TextXAlignment.Left

local CopyPlayerBtn = Instance.new("TextButton", PlayerIdFrame)
CopyPlayerBtn.Size = UDim2.new(0, 70, 1, 0)
CopyPlayerBtn.Position = UDim2.new(1, -75, 0, 0)
CopyPlayerBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
CopyPlayerBtn.Text = "نسخ"
CopyPlayerBtn.TextScaled = true
CopyPlayerBtn.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", CopyPlayerBtn).CornerRadius = UDim.new(0, 6)
CopyPlayerBtn.MouseButton1Click:Connect(function()
    if targetAnimId ~= "غير متاح" then
        setclipboard(targetAnimId)
        StarterGui:SetCore("SendNotification", {Title = "تم النسخ!", Text = "ID اللاعب: " .. targetAnimId, Duration = 2})
    end
end)

-- قسم الحركات
local EmotesSection = Instance.new("Frame", Panel)
EmotesSection.Size = UDim2.new(1, -20, 0, 300)
EmotesSection.Position = UDim2.new(0, 10, 0, 110)
EmotesSection.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
Instance.new("UICorner", EmotesSection).CornerRadius = UDim.new(0, 10)

local EmotesTitle = Instance.new("TextLabel", EmotesSection)
EmotesTitle.Size = UDim2.new(1, 0, 0, 30)
EmotesTitle.BackgroundTransparency = 1
EmotesTitle.Text = "الحركات المخصصة"
EmotesTitle.TextColor3 = Color3.fromRGB(255, 100, 200)
EmotesTitle.TextScaled = true
EmotesTitle.Font = Enum.Font.GothamBold

local SearchBox = Instance.new("TextBox", EmotesSection)
SearchBox.PlaceholderText = "ابحث بالاسم أو ID..."
SearchBox.Size = UDim2.new(1, -10, 0, 30)
SearchBox.Position = UDim2.new(0, 5, 0, 35)
SearchBox.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
SearchBox.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", SearchBox).CornerRadius = UDim.new(0, 6)

local EmotesScroll = Instance.new("ScrollingFrame", EmotesSection)
EmotesScroll.Size = UDim2.new(1, -10, 1, -170)
EmotesScroll.Position = UDim2.new(0, 5, 0, 70)
EmotesScroll.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
EmotesScroll.ScrollBarThickness = 4
EmotesScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
Instance.new("UICorner", EmotesScroll).CornerRadius = UDim.new(0, 6)

local emoteLayout = Instance.new("UIListLayout", EmotesScroll)
emoteLayout.Padding = UDim.new(0, 6)
emoteLayout.SortOrder = Enum.SortOrder.LayoutOrder

-- إضافة حركة
local AddFrame = Instance.new("Frame", EmotesSection)
AddFrame.Size = UDim2.new(1, -10, 0, 55)
AddFrame.Position = UDim2.new(0, 5, 1, -60)
AddFrame.BackgroundTransparency = 1

local InputID = Instance.new("TextBox", AddFrame)
InputID.PlaceholderText = "ID الحركة"
InputID.Size = UDim2.new(1, -70, 0, 25)
InputID.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
InputID.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", InputID).CornerRadius = UDim.new(0, 6)

local InputName = Instance.new("TextBox", AddFrame)
InputName.PlaceholderText = "اسم الحركة"
InputName.Size = UDim2.new(1, -70, 0, 25)
InputName.Position = UDim2.new(0, 0, 0, 30)
InputName.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
InputName.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", InputName).CornerRadius = UDim.new(0, 6)

local AddBtn = Instance.new("TextButton", AddFrame)
AddBtn.Size = UDim2.new(0, 60, 0, 55)
AddBtn.Position = UDim2.new(1, -65, 0, 0)
AddBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
AddBtn.Text = "إضافة"
AddBtn.TextScaled = true
AddBtn.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", AddBtn).CornerRadius = UDim.new(0, 6)

-- قسم التحكم
local ControlsSection = Instance.new("Frame", Panel)
ControlsSection.Size = UDim2.new(1, -20, 0, 280)
ControlsSection.Position = UDim2.new(0, 10, 0, 420)
ControlsSection.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
Instance.new("UICorner", ControlsSection).CornerRadius = UDim.new(0, 10)

local ControlsTitle = Instance.new("TextLabel", ControlsSection)
ControlsTitle.Size = UDim2.new(1, 0, 0, 30)
ControlsTitle.BackgroundTransparency = 1
ControlsTitle.Text = "التحكم"
ControlsTitle.TextColor3 = Color3.fromRGB(100, 200, 255)
ControlsTitle.TextScaled = true
ControlsTitle.Font = Enum.Font.GothamBold

local ControlsScroll = Instance.new("ScrollingFrame", ControlsSection)
ControlsScroll.Size = UDim2.new(1, -10, 1, -40)
ControlsScroll.Position = UDim2.new(0, 5, 0, 35)
ControlsScroll.BackgroundTransparency = 1
ControlsScroll.ScrollBarThickness = 4
ControlsScroll.CanvasSize = UDim2.new(0, 0, 0, 0)

local controlLayout = Instance.new("UIListLayout", ControlsScroll)
controlLayout.Padding = UDim.new(0, 6)
controlLayout.SortOrder = Enum.SortOrder.LayoutOrder

-- TextBoxes
local function makeBox(placeholder, default, order)
    local box = Instance.new("TextBox", ControlsScroll)
    box.PlaceholderText = placeholder
    box.Text = default
    box.Size = UDim2.new(1, 0, 0, 30)
    box.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    box.TextColor3 = Color3.new(1,1,1)
    box.TextSize = 13
    box.LayoutOrder = order
    Instance.new("UICorner", box).CornerRadius = UDim.new(0, 6)
    return box
end

local InputPlayer = makeBox("أول حرفين من الاسم", "", 0)
local InputSpeed = makeBox("سرعة الحركة", "30", 1)
local InputDist = makeBox("المسافة", "1.2", 2)
local InputRange = makeBox("الارتداد", "0.3", 3)
local InputOsc = makeBox("سرعة الارتداد", "4", 4)

-- أزرار
local function makeBtn(text, color, callback, order)
    local btn = Instance.new("TextButton", ControlsScroll)
    btn.Size = UDim2.new(1, 0, 0, 34)
    btn.BackgroundColor3 = color
    btn.Text = text
    btn.TextColor3 = Color3.new(1,1,1)
    btn.TextScaled = true
    btn.LayoutOrder = order
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    btn.MouseButton1Click:Connect(callback)
    return btn
end

makeBtn("Bang خلفي", Color3.fromRGB(0, 200, 0), function() targetPrefix = InputPlayer.Text:lower(); startBangBack() end, 10)
makeBtn("Bang أمامي", Color3.fromRGB(255, 140, 0), function() targetPrefix = InputPlayer.Text:lower(); startBangFront() end, 11)
makeBtn("إيقاف الكل", Color3.fromRGB(200, 0, 0), function() stopBangBack(); stopBangFront(); stopSync(); lockedFace = nil end, 12)
makeBtn("وجه للضحية", Color3.fromRGB(80, 130, 250), function() lockedFace = "front" end, 13)
makeBtn("وجه للخلف", Color3.fromRGB(200, 80, 80), function() lockedFace = "back" end, 14)

-- زر المزامنة
local syncBtn = makeBtn("تشغيل مزامنة", Color3.fromRGB(255, 200, 0), function()
    if syncEnabled then
        stopSync()
        syncBtn.Text = "تشغيل مزامنة"
        syncBtn.BackgroundColor3 = Color3.fromRGB(255, 200, 0)
    else
        targetPrefix = InputPlayer.Text:lower()
        startSync()
        syncBtn.Text = "إيقاف مزامنة"
        syncBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 200)
    end
end, 15)

-- تحديث Logs
local function updateLogs()
    if selectedEmoteKey and CustomEmotes[selectedEmoteKey] then
        LogsLabel.Text = "ID الحركة المختارة: " .. CustomEmotes[selectedEmoteKey].id
    else
        LogsLabel.Text = "ID الحركة المختارة: N/A"
    end
end

-- تحديث القائمة
local function refreshEmotes(filter)
    filter = (filter or ""):lower()
    for _, child in ipairs(EmotesScroll:GetChildren()) do
        if child:IsA("Frame") then child:Destroy() end
    end
    local y = 0
    for name, emote in pairs(CustomEmotes) do
        local searchStr = name:lower() .. emote.id:lower()
        if filter == "" or searchStr:find(filter, 1, true) then
            local frame = Instance.new("Frame", EmotesScroll)
            frame.Size = UDim2.new(1, -8, 0, 70)
            frame.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
            Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 6)

            local nameLabel = Instance.new("TextLabel", frame)
            nameLabel.Size = UDim2.new(1, -100, 0, 25)
            nameLabel.Position = UDim2.new(0, 5, 0, 5)
            nameLabel.BackgroundTransparency = 1
            nameLabel.Text = name
            nameLabel.TextColor3 = Color3.new(1,1,1)
            nameLabel.TextScaled = true
            nameLabel.TextXAlignment = Enum.TextXAlignment.Left

            local idLabel = Instance.new("TextLabel", frame)
            idLabel.Size = UDim2.new(1, -100, 0, 20)
            idLabel.Position = UDim2.new(0, 5, 0, 30)
            idLabel.BackgroundTransparency = 1
            idLabel.Text = "ID: " .. emote.id
            idLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
            idLabel.TextScaled = true
            idLabel.TextXAlignment = Enum.TextXAlignment.Left

            local playBtn = Instance.new("TextButton", frame)
            playBtn.Size = UDim2.new(0, 50, 0, 50)
            playBtn.Position = UDim2.new(1, -55, 0, 10)
            playBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
            playBtn.Text = "Play"
            playBtn.TextScaled = true
            Instance.new("UICorner", playBtn).CornerRadius = UDim.new(0, 6)
            playBtn.MouseButton1Click:Connect(function()
                currentEmoteKey = name
                ANIM_ID = "rbxassetid://" .. emote.id
                selectedEmoteKey = name
                updateLogs()
            end)

            frame.MouseButton1Click:Connect(function()
                selectedEmoteKey = name
                updateLogs()
            end)

            local freezeBtn = Instance.new("TextButton", frame)
            freezeBtn.Size = UDim2.new(0, 30, 0, 30)
            freezeBtn.Position = UDim2.new(1, -90, 0, 15)
            freezeBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 150)
            freezeBtn.Text = "Freeze"
            freezeBtn.TextScaled = true
            Instance.new("UICorner", freezeBtn).CornerRadius = UDim.new(0, 4)
            freezeBtn.MouseButton1Click:Connect(function()
                local t = animTrackBack or animTrackFront or syncTrack
                if t then t:AdjustSpeed(0) end
            end)

            local editBtn = Instance.new("TextButton", frame)
            editBtn.Size = UDim2.new(0, 30, 0, 30)
            editBtn.Position = UDim2.new(1, -125, 0, 15)
            editBtn.BackgroundColor3 = Color3.fromRGB(255, 200, 0)
            editBtn.Text = "Edit"
            editBtn.TextScaled = true
            Instance.new("UICorner", editBtn).CornerRadius = UDim.new(0, 4)
            editBtn.MouseButton1Click:Connect(function()
                local editBox = Instance.new("TextBox", frame)
                editBox.Size = UDim2.new(0, 100, 0, 25)
                editBox.Position = UDim2.new(0, 5, 0, 5)
                editBox.Text = name
                editBox:CaptureFocus()
                editBox.FocusLost:Connect(function(enter)
                    if enter and editBox.Text ~= "" and editBox.Text ~= name then
                        CustomEmotes[editBox.Text] = CustomEmotes[name]
                        CustomEmotes[name] = nil
                        if selectedEmoteKey == name then selectedEmoteKey = editBox.Text end
                        saveEmotes()
                        editBox:Destroy()
                        refreshEmotes(SearchBox.Text)
                    end
                end)
            end)

            local delBtn = Instance.new("TextButton", frame)
            delBtn.Size = UDim2.new(0, 30, 0, 30)
            delBtn.Position = UDim2.new(1, -160, 0, 15)
            delBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
            delBtn.Text = "X"
            delBtn.TextScaled = true
            Instance.new("UICorner", delBtn).CornerRadius = UDim.new(0, 4)
            delBtn.MouseButton1Click:Connect(function()
                CustomEmotes[name] = nil
                if selectedEmoteKey == name then selectedEmoteKey = next(CustomEmotes) end
                saveEmotes()
                refreshEmotes(SearchBox.Text)
            end)

            y += 1
        end
    end
    EmotesScroll.CanvasSize = UDim2.new(0, 0, 0, y * 76)
end

-- أحداث
SearchBox:GetPropertyChangedSignal("Text"):Connect(function() refreshEmotes(SearchBox.Text) end)

AddBtn.MouseButton1Click:Connect(function()
    local id = InputID.Text:match("%d+")
    local name = InputName.Text ~= "" and InputName.Text or ("Emote_" .. id)
    if id and not CustomEmotes[name] then
        CustomEmotes[name] = {id = id}
        saveEmotes()
        refreshEmotes(SearchBox.Text)
        InputID.Text = ""
        InputName.Text = ""
    end
end)

InputSpeed.FocusLost:Connect(function() local v = tonumber(InputSpeed.Text); if v then BANG_SPEED = v end end)
InputDist.FocusLost:Connect(function() local v = tonumber(InputDist.Text); if v then BASE_DISTANCE = v end end)
InputRange.FocusLost:Connect(function() local v = tonumber(InputRange.Text); if v then OSCILLATION_RANGE = v end end)
InputOsc.FocusLost:Connect(function() local v = tonumber(InputOsc.Text); if v then OSCILLATION_SPEED = v end end)

OpenBtn.MouseButton1Click:Connect(function() Panel.Visible = not Panel.Visible end)

controlLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ControlsScroll.CanvasSize = UDim2.new(0, 0, 0, controlLayout.AbsoluteContentSize.Y + 10)
end)

InputPlayer:GetPropertyChangedSignal("Text"):Connect(function()
    local p = findTargetByPrefix(InputPlayer.Text)
    if p then
        targetPlayer = p
        if syncEnabled then startSync() end
    end
end)

-- تحديث القائمة
refreshEmotes()
updateLogs()

-- خدمات
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- متغيرات
local targetPrefix = ""
local bangingBack = false
local bangingFront = false
local followConnBack = nil
local followConnFront = nil
local animTrackBack = nil
local animTrackFront = nil
local ANIM_ID = "rbxassetid://127193965947477"
local BANG_SPEED = 60
local BASE_DISTANCE = 1.2
local OSCILLATION_RANGE = 0.5
local OSCILLATION_SPEED = 3
local timeElapsedBack = 0
local timeElapsedFront = 0
local lockedFace = nil -- nil: تلقائي, "front": وجه للضحية, "back": خلف الضحية
local currentHeight = 0 -- الارتفاع الحالي
local targetHeight = 0 -- الارتفاع المستهدف
local heightChangeSpeed = 5 -- سرعة تغيير الارتفاع

-- وظائف عامة
local function getGuiParent()
    if gethui then
        local ok, ui = pcall(gethui)
        if ok and ui then return ui end
    end
    return game:GetService("CoreGui")
end

local function findTargetByPrefix(prefix)
    prefix = (prefix or ""):lower()
    if prefix == "" then return nil end
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Name:lower():sub(1, #prefix) == prefix then
            return p
        end
    end
    return nil
end

local function playAnim()
    local char = LocalPlayer.Character
    if not char then return nil end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return nil end
    local animator = hum:FindFirstChildOfClass("Animator")
    if not animator then
        animator = Instance.new("Animator")
        animator.Parent = hum
    end
    local anim = Instance.new("Animation")
    anim.AnimationId = ANIM_ID
    local track = animator:LoadAnimation(anim)
    track:Play()
    track.Looped = true
    return track
end

local function stopAnim(track)
    if track then
        pcall(function() track:Stop() end)
    end
end

-- Bang الخلفي
local function startBangBack()
    if bangingBack then return end
    local target = findTargetByPrefix(targetPrefix)
    if not target or not target.Character then
        warn("لا يوجد لاعب بهذا الاسم.")
        return
    end
    animTrackBack = playAnim()
    bangingBack = true
    timeElapsedBack = 0
    if followConnBack then followConnBack:Disconnect() end
    followConnBack = RunService.Heartbeat:Connect(function(dt)
        if not bangingBack then return end
        local myChar = LocalPlayer.Character
        local tChar = target.Character
        if not (myChar and tChar) then return end
        local myRoot = myChar:FindFirstChild("HumanoidRootPart")
        local tRoot = tChar:FindFirstChild("HumanoidRootPart")
        if not (myRoot and tRoot) then return end
        
        -- تحديث الارتفاع تدريجياً
        if currentHeight ~= targetHeight then
            local diff = targetHeight - currentHeight
            local change = math.sign(diff) * math.min(math.abs(diff), heightChangeSpeed * dt)
            currentHeight = currentHeight + change
        end
        
        timeElapsedBack = timeElapsedBack + dt
        local oscillation = math.sin(timeElapsedBack * OSCILLATION_SPEED) * OSCILLATION_RANGE
        local desiredPos = tRoot.Position - (tRoot.CFrame.LookVector * (BASE_DISTANCE + oscillation))
        
        -- تطبيق الارتفاع
        desiredPos = Vector3.new(desiredPos.X, desiredPos.Y + currentHeight, desiredPos.Z)
        
        local moveDir = (desiredPos - myRoot.Position)
        if moveDir.Magnitude > 0.05 then
            local facePos
            if lockedFace == "front" then
                facePos = tRoot.Position + Vector3.new(0, currentHeight, 0)
            elseif lockedFace == "back" then
                facePos = tRoot.Position - tRoot.CFrame.LookVector * BASE_DISTANCE * 2 + Vector3.new(0, currentHeight, 0)
            else
                facePos = tRoot.Position + Vector3.new(0, currentHeight, 0)
            end
            
            -- حساب الموضع الجديد مع الحفاظ على اتجاه الوجه
            local newPosition = myRoot.Position + moveDir.Unit * math.min(moveDir.Magnitude, (BANG_SPEED * dt))
            myRoot.CFrame = CFrame.new(newPosition, facePos)
        end
    end)
end

local function stopBangBack()
    bangingBack = false
    if followConnBack then followConnBack:Disconnect() end
    stopAnim(animTrackBack)
    animTrackBack = nil
end

-- Bang الأمامي
local function startBangFront()
    if bangingFront then return end
    local target = findTargetByPrefix(targetPrefix)
    if not target or not target.Character then
        warn("لا يوجد لاعب بهذا الاسم.")
        return
    end
    animTrackFront = playAnim()
    bangingFront = true
    timeElapsedFront = 0
    if followConnFront then followConnFront:Disconnect() end
    followConnFront = RunService.Heartbeat:Connect(function(dt)
        if not bangingFront then return end
        local myChar = LocalPlayer.Character
        local tChar = target.Character
        if not (myChar and tChar) then return end
        local myRoot = myChar:FindFirstChild("HumanoidRootPart")
        local tRoot = tChar:FindFirstChild("HumanoidRootPart")
        if not (myRoot and tRoot) then return end
        
        -- تحديث الارتفاع تدريجياً
        if currentHeight ~= targetHeight then
            local diff = targetHeight - currentHeight
            local change = math.sign(diff) * math.min(math.abs(diff), heightChangeSpeed * dt)
            currentHeight = currentHeight + change
        end
        
        timeElapsedFront = timeElapsedFront + dt
        local oscillation = math.sin(timeElapsedFront * OSCILLATION_SPEED) * OSCILLATION_RANGE
        local desiredPos = tRoot.Position + (tRoot.CFrame.LookVector * (BASE_DISTANCE + oscillation))
        
        -- تطبيق الارتفاع
        desiredPos = Vector3.new(desiredPos.X, desiredPos.Y + currentHeight, desiredPos.Z)
        
        local moveDir = (desiredPos - myRoot.Position)
        if moveDir.Magnitude > 0.05 then
            local facePos
            if lockedFace == "front" then
                facePos = tRoot.Position + Vector3.new(0, currentHeight, 0)
            elseif lockedFace == "back" then
                facePos = tRoot.Position + tRoot.CFrame.LookVector * BASE_DISTANCE * 2 + Vector3.new(0, currentHeight, 0)
            else
                facePos = tRoot.Position + Vector3.new(0, currentHeight, 0)
            end
            
            -- حساب الموضع الجديد مع الحفاظ على اتجاه الوجه
            local newPosition = myRoot.Position + moveDir.Unit * math.min(moveDir.Magnitude, (BANG_SPEED * dt))
            myRoot.CFrame = CFrame.new(newPosition, facePos)
        end
    end)
end

local function stopBangFront()
    bangingFront = false
    if followConnFront then followConnFront:Disconnect() end
    stopAnim(animTrackFront)
    animTrackFront = nil
end

local function turnFaceToTarget(isBack)
    local target = findTargetByPrefix(targetPrefix)
    if not target or not target.Character then
        warn("لا يوجد لاعب بهذا الاسم.")
        return
    end
    local myChar = LocalPlayer.Character
    local tChar = target.Character
    if not (myChar and tChar) then return end
    local myRoot = myChar:FindFirstChild("HumanoidRootPart")
    local tRoot = tChar:FindFirstChild("HumanoidRootPart")
    if not (myRoot and tRoot) then return end
    if isBack then
        local backPos = tRoot.Position - tRoot.CFrame.LookVector * BASE_DISTANCE * 2 + Vector3.new(0, currentHeight, 0)
        myRoot.CFrame = CFrame.new(myRoot.Position, backPos)
    else
        local frontPos = tRoot.Position + Vector3.new(0, currentHeight, 0)
        myRoot.CFrame = CFrame.new(myRoot.Position, frontPos)
    end
end

-- UI
do
    local parent = getGuiParent()
    local old = parent:FindFirstChild("BangUI")
    if old then old:Destroy() end
end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "BangUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = getGuiParent()

local OpenBtn = Instance.new("TextButton", ScreenGui)
OpenBtn.Size = UDim2.new(0, 50, 0, 50)
OpenBtn.Position = UDim2.new(0, 20, 0, 200)
OpenBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
OpenBtn.Text = "☰"
OpenBtn.TextScaled = true
OpenBtn.TextColor3 = Color3.new(1,1,1)
OpenBtn.Active = true
OpenBtn.Draggable = true
Instance.new("UICorner", OpenBtn).CornerRadius = UDim.new(1, 0)

local Panel = Instance.new("Frame", ScreenGui)
Panel.Size = UDim2.new(0, 210, 0, 520)
Panel.Position = UDim2.new(0, 100, 0, 100)
Panel.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
Panel.Visible = false
Panel.Active = true
Panel.Draggable = true
Instance.new("UICorner", Panel).CornerRadius = UDim.new(0, 10)

local function makeBox(placeholder, posY)
    local box = Instance.new("TextBox", Panel)
    box.PlaceholderText = placeholder
    box.Size = UDim2.new(1, -14, 0, 22)
    box.Position = UDim2.new(0, 7, 0, posY)
    box.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    box.TextColor3 = Color3.new(1, 1, 1)
    box.TextSize = 12
    box.ClearTextOnFocus = false
    box.Focused:Connect(function()
        box.Text = ""
    end)
    Instance.new("UICorner", box).CornerRadius = UDim.new(0, 6)
    return box
end

-- زر عرض ونسخ رقم الأنيميشن الحالي المستخدم
local CopyAnimIdBtn = Instance.new("TextButton", Panel)
CopyAnimIdBtn.Size = UDim2.new(1, -14, 0, 24)
CopyAnimIdBtn.Position = UDim2.new(0, 7, 0, 8)
CopyAnimIdBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 200)
CopyAnimIdBtn.TextColor3 = Color3.new(1, 1, 1)
CopyAnimIdBtn.TextSize = 12
CopyAnimIdBtn.Text = "..."
Instance.new("UICorner", CopyAnimIdBtn).CornerRadius = UDim.new(0, 6)

local function getCurrentAnimId()
    local char = LocalPlayer.Character
    if not char then return nil end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return nil end
    local animator = hum:FindFirstChildOfClass("Animator")
    if not animator then return nil end
    local playingTracks = animator:GetPlayingAnimationTracks()
    for i = #playingTracks, 1, -1 do
        local track = playingTracks[i]
        if track and track.Animation then
            local animId = tostring(track.Animation.AnimationId):match("%d+")
            if animId and animId ~= "" then
                return animId
            end
        end
    end
    return nil
end

RunService.Heartbeat:Connect(function()
    local animId = getCurrentAnimId()
    if animId then
        CopyAnimIdBtn.Text = animId
    else
        CopyAnimIdBtn.Text = "..."
    end
end)

CopyAnimIdBtn.MouseButton1Click:Connect(function()
    local animId = getCurrentAnimId()
    if animId then
        setclipboard(animId)
    end
end)

local InputName = makeBox("أول حرفين من اسم اللاعب", 38)
local InputSpeed = makeBox("سرعة Bang", 66)
local InputAnim = makeBox("ID أنيميشن Bang", 94)
local InputBaseDist = makeBox("المسافة الأساسية", 122)
local InputOscRange = makeBox("مدى الارتداد", 150)
local InputOscSpeed = makeBox("سرعة الارتداد", 178)

-- عناصر التحكم في الارتفاع
local InputHeight = makeBox("الارتفاع الحالي", 206)
InputHeight.Text = "0"

local InputTargetHeight = makeBox("الارتفاع المستهدف", 234)
InputTargetHeight.Text = "0"

local InputHeightSpeed = makeBox("سرعة تغيير الارتفاع", 262)
InputHeightSpeed.Text = "5"

local ApplyHeightBtn = Instance.new("TextButton", Panel)
ApplyHeightBtn.Size = UDim2.new(1, -14, 0, 24)
ApplyHeightBtn.Position = UDim2.new(0, 7, 0, 290)
ApplyHeightBtn.BackgroundColor3 = Color3.fromRGB(100, 200, 100)
ApplyHeightBtn.Text = "تطبيق الارتفاع"
ApplyHeightBtn.TextColor3 = Color3.new(1, 1, 1)
ApplyHeightBtn.TextSize = 12
Instance.new("UICorner", ApplyHeightBtn).CornerRadius = UDim.new(0, 6)

local StartBtnBack = Instance.new("TextButton", Panel)
StartBtnBack.Size = UDim2.new(1, -14, 0, 24)
StartBtnBack.Position = UDim2.new(0, 7, 0, 318)
StartBtnBack.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
StartBtnBack.Text = "تشغيل Bang خلفي"
StartBtnBack.TextColor3 = Color3.new(1, 1, 1)
StartBtnBack.TextSize = 12
Instance.new("UICorner", StartBtnBack).CornerRadius = UDim.new(0, 6)

local StartBtnFront = Instance.new("TextButton", Panel)
StartBtnFront.Size = UDim2.new(1, -14, 0, 24)
StartBtnFront.Position = UDim2.new(0, 7, 0, 346)
StartBtnFront.BackgroundColor3 = Color3.fromRGB(255, 140, 0)
StartBtnFront.Text = "تشغيل Bang أمامي"
StartBtnFront.TextColor3 = Color3.new(1, 1, 1)
StartBtnFront.TextSize = 12
Instance.new("UICorner", StartBtnFront).CornerRadius = UDim.new(0, 6)

local StopBtn = Instance.new("TextButton", Panel)
StopBtn.Size = UDim2.new(1, -14, 0, 24)
StopBtn.Position = UDim2.new(0, 7, 0, 374)
StopBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
StopBtn.Text = "إيقاف الكل"
StopBtn.TextColor3 = Color3.new(1, 1, 1)
StopBtn.TextSize = 12
Instance.new("UICorner", StopBtn).CornerRadius = UDim.new(0, 6)

local InputAnimSpeed = makeBox("سرعة الأنيميشن", 402)

local ApplyAnimSpeedBtn = Instance.new("TextButton", Panel)
ApplyAnimSpeedBtn.Size = UDim2.new(1, -14, 0, 24)
ApplyAnimSpeedBtn.Position = UDim2.new(0, 7, 0, 430)
ApplyAnimSpeedBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 200)
ApplyAnimSpeedBtn.Text = "تطبيق السرعة"
ApplyAnimSpeedBtn.TextColor3 = Color3.new(1, 1, 1)
ApplyAnimSpeedBtn.TextSize = 12
Instance.new("UICorner", ApplyAnimSpeedBtn).CornerRadius = UDim.new(0, 6)

local FreezeAnimBtn = Instance.new("TextButton", Panel)
FreezeAnimBtn.Size = UDim2.new(1, -14, 0, 24)
FreezeAnimBtn.Position = UDim2.new(0, 7, 0, 458)
FreezeAnimBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 150)
FreezeAnimBtn.Text = "تجميد الأنيميشن"
FreezeAnimBtn.TextColor3 = Color3.new(1, 1, 1)
FreezeAnimBtn.TextSize = 12
Instance.new("UICorner", FreezeAnimBtn).CornerRadius = UDim.new(0, 6)

local FaceBtn = Instance.new("TextButton", Panel)
FaceBtn.Size = UDim2.new(0.5, -10, 0, 24)
FaceBtn.Position = UDim2.new(0, 7, 0, 486)
FaceBtn.BackgroundColor3 = Color3.fromRGB(80, 130, 250)
FaceBtn.Text = "لف وجهك للضحية"
FaceBtn.TextColor3 = Color3.new(1, 1, 1)
FaceBtn.TextSize = 12
Instance.new("UICorner", FaceBtn).CornerRadius = UDim.new(0, 6)

local FaceBackBtn = Instance.new("TextButton", Panel)
FaceBackBtn.Size = UDim2.new(0.5, -10, 0, 24)
FaceBackBtn.Position = UDim2.new(0.5, 7, 0, 486)
FaceBackBtn.BackgroundColor3 = Color3.fromRGB(200, 80, 80)
FaceBackBtn.Text = "لف وجهك للجهة الثانية"
FaceBackBtn.TextColor3 = Color3.new(1, 1, 1)
FaceBackBtn.TextSize = 12
Instance.new("UICorner", FaceBackBtn).CornerRadius = UDim.new(0, 6)

ApplyAnimSpeedBtn.MouseButton1Click:Connect(function()
    local val = tonumber(InputAnimSpeed.Text)
    if val and val > 0 then
        local currentTrack = animTrackBack or animTrackFront
        if currentTrack then
            currentTrack:AdjustSpeed(val)
        end
    end
end)

FreezeAnimBtn.MouseButton1Click:Connect(function()
    local currentTrack = animTrackBack or animTrackFront
    if currentTrack then
        currentTrack:AdjustSpeed(0)
    end
end)

ApplyHeightBtn.MouseButton1Click:Connect(function()
    local heightVal = tonumber(InputHeight.Text)
    local targetHeightVal = tonumber(InputTargetHeight.Text)
    local speedVal = tonumber(InputHeightSpeed.Text)
    
    if heightVal then
        currentHeight = heightVal
    end
    
    if targetHeightVal then
        targetHeight = targetHeightVal
    end
    
    if speedVal and speedVal > 0 then
        heightChangeSpeed = speedVal
    end
end)

OpenBtn.MouseButton1Click:Connect(function()
    Panel.Visible = not Panel.Visible
end)

InputName.FocusLost:Connect(function()
    targetPrefix = InputName.Text:lower()
end)

InputSpeed.FocusLost:Connect(function()
    local val = tonumber(InputSpeed.Text)
    if val and val > 0 then
        BANG_SPEED = val
    end
end)

InputAnim.FocusLost:Connect(function()
    if InputAnim.Text ~= "" then
        ANIM_ID = "rbxassetid://" .. tostring(InputAnim.Text)
    end
end)

InputBaseDist.FocusLost:Connect(function()
    local val = tonumber(InputBaseDist.Text)
    if val then
        BASE_DISTANCE = val
    end
end)

InputOscRange.FocusLost:Connect(function()
    local val = tonumber(InputOscRange.Text)
    if val then
        OSCILLATION_RANGE = val
    end
end)

InputOscSpeed.FocusLost:Connect(function()
    local val = tonumber(InputOscSpeed.Text)
    if val then
        OSCILLATION_SPEED = val
    end
end)

StartBtnBack.MouseButton1Click:Connect(function()
    targetPrefix = InputName.Text:lower()
    startBangBack()
end)

StartBtnFront.MouseButton1Click:Connect(function()
    targetPrefix = InputName.Text:lower()
    startBangFront()
end)

StopBtn.MouseButton1Click:Connect(function()
    stopBangBack()
    stopBangFront()
    lockedFace = nil
end)

FaceBtn.MouseButton1Click:Connect(function()
    targetPrefix = InputName.Text:lower()
    lockedFace = "front"
end)

FaceBackBtn.MouseButton1Click:Connect(function()
    targetPrefix = InputName.Text:lower()
    lockedFace = "back"
end)
